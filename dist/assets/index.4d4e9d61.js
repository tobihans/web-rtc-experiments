import{i as S,d as $,m as y,z as h,n as c,j as b,H as f,a as u,F as E,Q as I,q as w,W as m}from"./vendor.07244b42.js";const T=function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const o of e.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?e.credentials="include":t.crossorigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function i(t){if(t.ep)return;t.ep=!0;const e=n(t);fetch(t.href,e)}};T();const k=S({apiKey:"AIzaSyADNw-pDIlz0_0_w1B6dOHs3ergqj4DWZ0",authDomain:"webrtc-c34f0.firebaseapp.com",projectId:"webrtc-c34f0",storageBucket:"webrtc-c34f0.appspot.com",messagingSenderId:"89592807533",appId:"1:89592807533:web:f25a0f76b9ffce8251bf64"});const p={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}],iceCandidatePoolSize:10},g=$(k);y.data("app",()=>({roomId:null,peerConn:null,roomDialog:null,localStream:null,remoteStream:null,async openMedia(){this.localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),this.$refs.localVideo.srcObject=this.localStream,this.remoteStream=new MediaStream,this.$refs.remoteVideo.srcObject=this.remoteStream,console.log(this.localStream),this.$refs.cameraBtn.disabled=!0,this.$refs.createBtn.disabled=!1,this.$refs.joinBtn.disabled=!1,this.$refs.leaveBtn.disabled=!1},async create(){this.$refs.createBtn.disabled=!0,this.$refs.joinBtn.disabled=!0;const r=await h(c(g,"rooms"),{});this.roomId=r.id,this.$refs.currentRoom.innerText=`Room id ${this.roomId}: You're the caller`,this.peerConn=new RTCPeerConnection(p),this.listeners(),this.localStream.getTracks().forEach(e=>{this.peerConn.addTrack(e,this.localStream)});const a=c(r,"callerCandidates");this.peerConn.addEventListener("icecandidate",async e=>{if(!e.candidate){console.log("Got final candidate");return}console.log("New candidate:",e.candidate),await h(a,e.candidate.toJSON())}),console.log("Creating the room");const n=await this.peerConn.createOffer();await this.peerConn.setLocalDescription(n);const i={offer:{type:n.type,sdp:n.sdp}};await b(r,i),this.peerConn.addEventListener("track",e=>{console.log("Remote track received",e.streams[0]),e.streams[0].getTracks().forEach(o=>{console.log("Add a track to the remote remote stream",o),this.remoteStream.addTrack(o)})}),f(r,async e=>{console.log("Got updated room: ",e.data());const o=e.data();!this.peerConn.currentRemoteDescription&&(o==null?void 0:o.answer)&&(console.log("Set remote   desc:",o==null?void 0:o.answer),await this.peerConn.setRemoteDescription(new RTCSessionDescription(o==null?void 0:o.answer)))});const t=this.peerConn;f(c(r,"calleeCandidates"),e=>{e.docChanges().forEach(async o=>{if(o.type=="added"){const l=o.doc.data();console.log(`Got new remote ICE candidate: ${JSON.stringify(l)}`),await t.addIceCandidate(new RTCIceCandidate(l))}})})},async join(){this.$refs.createBtn.disabled=!0,this.$refs.joinBtn.disabled=!0,this.$refs.confirmJoinBtn.addEventListener("click",async()=>{console.log(`Join room: ${this.roomId}`),this.$refs.currentRoom.innerText=`Room ${this.roomId}: You're are the callee!`,await this.joinById(this.roomId)},{once:!0}),this.roomDialog.open()},async joinById(r){const a=u(g,"rooms",`${r}`),n=await E(a);if(console.log(`Got room: ${n.exists()}`),n.exists()){console.log("Create PeerConnection with configuration: ",p),this.peerConn=new RTCPeerConnection(p),this.listeners(),this.localStream.getTracks().forEach(s=>{this.peerConn.addTrack(s,this.localStream)});const i=c(a,"calleeCandidates");this.peerConn.addEventListener("icecandidate",async s=>{if(!s.candidate){console.log("Got final candidate");return}console.log("New candidate:",s.candidate),await h(i,s.candidate.toJSON())}),this.peerConn.addEventListener("track",s=>{console.log("Add track to the remoteStream:",s.streams[0]),s.streams[0].getTracks().forEach(d=>{console.log("Add a track to the remote Stream",d),this.remoteStream.addTrack(d)})});const t=n.data().offer;console.log("Got offer",t),await this.peerConn.setRemoteDescription(new RTCSessionDescription(t));const e=await this.peerConn.createAnswer();console.log("Created answer: ",e),await this.peerConn.setLocalDescription(e);const o={answer:{type:e.type,sdp:e.sdp}};await I(a,o);const l=this.peerConn;f(c(a,"callerCandidates"),s=>{s.docChanges().forEach(async d=>{if(d.type=="added"){const C=d.doc.data();console.log(`Got new remote ICE candidate: ${JSON.stringify(C)}`),await l.addIceCandidate(new RTCIceCandidate(C))}})})}},async leave(){if(this.$refs.localVideo.srcObject.getTracks().forEach(a=>a.stop()),this.remoteStream&&this.remoteStream.getTracks().forEach(a=>a.stop()),this.peerConn&&this.peerConn.close(),this.$refs.localVideo.srcObject=null,this.$refs.remoteVideo.srcObject=null,this.$refs.cameraBtn.disabled=!1,this.$refs.joinBtn.disabled=!0,this.$refs.createBtn.disabled=!0,this.$refs.hangupBtn.disabled=!0,this.$refs.currentRoom.innerText="",this.roomId){const a=u(g,"rooms",`${this.roomId}`);(await w(c(a,"calleeCandidates"))).forEach(async t=>{await m(t.ref)}),(await w(c(a,"callerCandidates"))).forEach(async t=>{await m(t.ref)}),await m(a)}window.location.replace("/")},async listeners(){console.log(this.peerConn),this.peerConn.addEventListener("icegatheringstatechange",()=>{console.log(`ICE gathering state changed: ${this.peerConn.iceGatheringState}`)}),this.peerConn.addEventListener("connectionstatechange",()=>{console.log(`Connection state change: ${this.peerConn.connectionState}`)}),this.peerConn.addEventListener("signalingstatechange",()=>{console.log(`Signaling state change: ${this.peerConn.signalingState}`)}),this.peerConn.addEventListener("iceconnectionstatechange ",()=>{console.log(`ICE connection state change: ${this.peerConn.iceConnectionState}`)})},async init(){this.roomDialog=window.roomDialog}}));y.start();
